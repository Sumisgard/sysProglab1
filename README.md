# Сервер распределенной памяти (Distributed Memory Server)

## Описание

Реализация сервера распределенной памяти - аналога разделяемой памяти (Shared Memory), но с возможностью работы по сети. 
Реализация полностью обрабатывает все исключительные ситуации, возникающие для разделяемой памяти. 
Внешний интерфейс и возвращаемые значения совместимы со стандартом POSIX.1 (shmget, shmat, etc.).

## Архитектура

Сервер реализует клиент-серверную архитектуру с использованием TCP-протокола для передачи данных.
Сервер поддерживает следующие операции:

- Создание сегментов распределенной памяти
- Присоединение к сегментам
- Отсоединение от сегментов
- Чтение данных из сегментов
- Запись данных в сегменты
- Удаление сегментов
- Управление сегментами через shmctl

## Протокол взаимодействия

Сервер использует собственный протокол поверх TCP с определенными командами:

- `CMD_CREATE_SEGMENT` - создание сегмента
- `CMD_ATTACH_SEGMENT` - присоединение к сегменту
- `CMD_DETACH_SEGMENT` - отсоединение от сегмента
- `CMD_REMOVE_SEGMENT` - удаление сегмента
- `CMD_READ_DATA` - чтение данных
- `CMD_WRITE_DATA` - запись данных
- `CMD_SHMCTL` - управление сегментом

## Особенности реализации

- Поддержка многопоточного доступа с использованием мьютексов
- Обработка всех возможных ошибок (EACCES, EINVAL, ENOMEM, ENOENT и т.д.)
- Использование mmap для создания сегментов памяти
- Поддержка флагов разделяемой памяти (SHM_RDONLY и др.)
- Корректная обработка сигналов завершения
- Защита от переполнения буфера

## Компиляция

Для компиляции сервера и клиентской библиотеки используйте команду:

```bash
make
```

Или для отладочной версии:

```bash
make debug
```

## Запуск

Запуск сервера на порту по умолчанию (8080):

```bash
./distributed_shm_server
```

Запуск сервера на указанном порту:

```bash
./distributed_shm_server 8081
```

## Использование клиентской библиотеки

Клиентская библиотека предоставляет POSIX-совместимый интерфейс для работы с распределенной памятью:

### Подключение к серверу
```c
#include <distributed_shm_client.h>

// Инициализация клиентской библиотеки
if (distributed_shm_init("localhost", 8080) != 0) {
    perror("distributed_shm_init failed");
    return 1;
}

// Не забудьте очистить ресурсы в конце
distributed_shm_cleanup();
```

### Создание сегмента разделяемой памяти
```c
key_t key = ftok(".", 'R');  // или используйте IPC_PRIVATE
int shmid = shmget(key, 4096, IPC_CREAT | 0666);
if (shmid == -1) {
    perror("shmget");
    return 1;
}
```

### Присоединение к сегменту
```c
char *shm_ptr = (char*)shmat(shmid, NULL, 0);
if (shm_ptr == (char*)-1) {
    perror("shmat");
    return 1;
}
```

### Работа с данными
```c
// Запись данных
strcpy(shm_ptr, "Hello, distributed SHM!");

// Чтение данных
printf("Data: %s\n", shm_ptr);
```

### Отсоединение и удаление
```c
// Отсоединение от сегмента
if (shmdt(shm_ptr) == -1) {
    perror("shmdt");
    return 1;
}

// Удаление сегмента
if (shmctl(shmid, IPC_RMID, NULL) == -1) {
    perror("shmctl");
    return 1;
}
```

## Сборка и использование клиентской библиотеки

После компиляции проекта будут созданы:

- `distributed_shm_server` - исполняемый файл сервера
- `libdistributed_shm.a` - статическая библиотека клиента
- `libdistributed_shm.so` - динамическая библиотека клиента

Для компиляции вашей программы с использованием клиентской библиотеки:

```bash
gcc -o my_program my_program.c -L. -ldistributed_shm -pthread
```

## Установка

Для установки сервера и библиотек в систему:

```bash
make install
```

## Файлы проекта

- `distributed_shm.h` - заголовочный файл с определениями протокола
- `distributed_shm_server.c` - реализация сервера
- `distributed_shm_client.h` - заголовочный файл клиентской библиотеки
- `distributed_shm_client.c` - реализация клиентской библиотеки
- `Makefile` - файл для сборки проекта
- `test_dshm.c` - тестовая программа
- `README.md` - документация

## Совместимость

Сервер реализует POSIX-совместимый интерфейс для работы с распределенной памятью.
Поддерживает основные функции POSIX: shmget, shmat, shmdt, shmctl.

## Тестирование

Для тестирования функциональности можно использовать тестовую программу:

```bash
# Сначала запустите сервер в одном терминале
./distributed_shm_server

# Затем в другом терминале запустите тест
make run-test
```

## Автор

Реализация сервера распределенной памяти для лабораторной работы по системному программированию.
